name: Build with CMake and Ninja

on:
  push:
    branches:
      - main
    tags:
      - '*'
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup LLVM (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          wget https://github.com/mstorsjo/llvm-mingw/releases/download/20230614/llvm-mingw-20230614-ucrt-ubuntu-20.04-x86_64.tar.xz
          tar xf llvm-mingw-20230614-ucrt-ubuntu-20.04-x86_64.tar.xz
          echo "$(pwd)/llvm-mingw-20230614-ucrt-ubuntu-20.04-x86_64/bin" >> $GITHUB_PATH

      - name: Update Dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: sudo apt update

      - name: Install Dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: sudo apt-get install ninja-build xorg-dev libglu1-mesa-dev libxrandr-dev libxi-dev libxinerama-dev libxcursor-dev libxxf86vm-dev

      - name: Install Ninja (Windows)
        if: runner.os == 'Windows'
        run: choco install ninja

      - name: Install Ninja (macOS)
        if: runner.os == 'macOS'
        run: brew install ninja

      - name: Install CMake (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake || brew upgrade cmake || true
          cmake --version

      - name: Check CMake version
        run: cmake --version

      - name: Verify submodules
        shell: bash
        run: |
          git submodule status
          if git submodule status | grep -q '^-'; then
            echo "Some submodules not initialized, initializing..."
            git submodule update --init --recursive
          else
            echo "All submodules initialized"
          fi

      - name: Create Build Directory
        run: mkdir -p build

      - name: Check build directory
        run: |
          pwd
          ls -la
          ls -la build/ || echo "Build directory is empty"

      - name: Run CMake
        shell: bash
        run: |
          set -e
          cd build
          echo "Running CMake from: $(pwd)"
          echo "Source directory: $(cd .. && pwd)"
          echo "CMake version: $(cmake --version)"
          echo "Ninja version: $(ninja --version || echo 'Ninja not found')"
          echo "Compiler: $(c++ --version || echo 'Compiler check failed')"
          
          # Run CMake and capture output
          if cmake .. -GNinja -DCMAKE_BUILD_TYPE=Release -DCMAKE_VERBOSE_MAKEFILE=ON > cmake_output.log 2>&1; then
            echo "CMake configuration succeeded"
            cat cmake_output.log
          else
            echo "=== CMake failed. Full output: ==="
            cat cmake_output.log
            exit 1
          fi

      - name: Upload CMake output (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cmake-output-${{ runner.os }}
          path: build/cmake_output.log

      - name: Build
        shell: bash
        run: |
          cd build
          ninja

      - name: Create Zip File (Windows)
        if: runner.os == 'Windows'
        run: |
          cd build
          powershell Compress-Archive -Path bin/* -DestinationPath bin.zip

      - name: Create Zip File (Linux and macOS)
        if: runner.os != 'Windows'
        run: |
          cd build
          zip -r bin.zip bin/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-bin-${{ runner.os }}
          path: build/bin.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref_type == 'tag'
    continue-on-error: true

    steps:
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: build-bin-Windows
          path: release/windows/
        continue-on-error: true

      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: build-bin-Linux
          path: release/linux/
        continue-on-error: true

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: build-bin-macOS
          path: release/macos/
        continue-on-error: true

      - name: Extract Linux and macOS artifacts
        run: |
          cd release/linux
          if [ -f bin.zip ]; then
            unzip -q bin.zip
            rm bin.zip
          fi
          cd ../macos
          if [ -f bin.zip ]; then
            unzip -q bin.zip
            rm bin.zip
          fi

      - name: Prepare release files
        run: |
          mkdir -p release/assets
          # Windows executable (if available)
          if find release/windows -name "int_tri.exe" 2>/dev/null | head -1 | xargs -I {} cp {} release/assets/int_tri-windows.exe 2>/dev/null; then
            echo "Windows executable found"
          else
            echo "Windows executable not found (build may have failed)"
          fi
          # Linux executable (if available)
          if find release/linux -name "int_tri" -type f 2>/dev/null | head -1 | xargs -I {} sh -c 'cp "$1" release/assets/int_tri-linux && chmod +x release/assets/int_tri-linux' _ {} 2>/dev/null; then
            echo "Linux executable found"
          else
            echo "Linux executable not found (build may have failed)"
          fi
          # macOS executable (if available)
          if find release/macos -name "int_tri" -type f 2>/dev/null | head -1 | xargs -I {} sh -c 'cp "$1" release/assets/int_tri-macos && chmod +x release/assets/int_tri-macos' _ {} 2>/dev/null; then
            echo "macOS executable found"
          else
            echo "macOS executable not found (build may have failed)"
          fi
          echo "Available release files:"
          ls -la release/assets/ || echo "No release files found"

      - name: Check for release files
        id: check_files
        run: |
          if [ -n "$(ls -A release/assets/ 2>/dev/null)" ]; then
            echo "files_exist=true" >> $GITHUB_OUTPUT
            echo "Found release files:"
            ls -la release/assets/
          else
            echo "files_exist=false" >> $GITHUB_OUTPUT
            echo "No release files found"
          fi

      - name: Create Release
        if: steps.check_files.outputs.files_exist == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: release/assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Warn if no release files
        if: steps.check_files.outputs.files_exist == 'false'
        run: |
          echo "Warning: No release files were created. Some builds may have failed."
          exit 0
